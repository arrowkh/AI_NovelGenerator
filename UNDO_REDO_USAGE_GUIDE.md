# 撤销/重做系统使用指南

## 快速开始

### 基本快捷键

- **Ctrl+Z**: 撤销上一个操作
- **Ctrl+Y**: 重做被撤销的操作
- **Ctrl+Shift+Z**: 重做（备选快捷键）
- **Ctrl+H**: 打开操作历史面板

### 菜单操作

在应用程序顶部的菜单栏中：

```
编辑
├─ 撤销 (Ctrl+Z)
├─ 重做 (Ctrl+Y)
└─ 操作历史 (Ctrl+H)
```

## 使用场景

### 场景 1: 编辑章节内容

1. 在 "Chapters Manage" 标签页中选择一个章节
2. 修改章节内容
3. 点击"保存修改"按钮（**重要：只有保存后操作才会被记录**）
4. 如果不满意修改，按 `Ctrl+Z` 撤销
5. 如果想恢复修改，按 `Ctrl+Y` 重做

**注意事项**：
- 必须点击"保存修改"按钮，修改才会被记录到撤销系统
- 在保存之前，可以直接在编辑器中使用 Ctrl+Z 撤销编辑（这是编辑器本身的功能）
- 保存后，使用全局 Ctrl+Z 可以撤销整个保存操作

### 场景 2: 生成章节

1. 在"Novel Generator"标签页中配置章节参数
2. 点击"生成章节草稿"或"定稿章节"
3. 等待生成完成
4. 如果对生成结果不满意，按 `Ctrl+Z` 撤销生成
5. 原来的内容会被恢复

**提示**：
- 生成操作会自动记录到撤销系统
- 可以多次尝试生成，每次都会被记录
- 撤销后可以用 Ctrl+Y 恢复任意一次生成结果

### 场景 3: 修改小说设定

1. 在"Novel Architecture"标签页中编辑设定
2. 点击"保存修改"
3. 如果需要回到之前的设定，按 `Ctrl+Z`
4. 系统会恢复之前的设定内容

**支持的设定类型**：
- Novel Architecture（小说架构）
- Chapter Blueprint（章节蓝图）
- Character State（角色状态）
- Global Summary（全局摘要）

### 场景 4: 查看和管理操作历史

1. 按 `Ctrl+H` 打开操作历史面板
2. 查看最近的所有操作（最多显示100条）
3. 可以直接从面板中点击"撤销"或"重做"
4. 点击"导出历史"可以保存操作记录到文本文件
5. 点击"分支管理"可以创建和管理分支

**历史面板功能**：
```
操作历史面板
├─ 查看操作列表（时间倒序）
├─ 撤销/重做按钮
├─ 统计信息（可撤销数、可重做数、当前分支）
├─ 导出历史到文件
├─ 清空所有历史
└─ 分支管理
```

### 场景 5: 使用分支管理（时间旅行）

**什么时候使用分支？**
- 当你想尝试两种不同的修改方向
- 当你不确定哪种修改更好时
- 当你想保留多个版本进行对比时

**操作步骤**：

1. **创建分支**
   ```
   操作历史面板 → 分支管理 → 创建分支
   输入分支名称：如 "版本A"
   ```

2. **在主分支工作**
   ```
   进行一些修改...
   保存修改...
   ```

3. **切换到新分支**
   ```
   分支管理 → 切换分支 → 选择 "版本A"
   ```

4. **在新分支工作**
   ```
   进行另一些修改...
   保存修改...
   ```

5. **在分支间切换**
   ```
   随时可以在 main 和 版本A 之间切换
   每个分支保留独立的修改历史
   ```

6. **对比和选择**
   ```
   切换到 main → 查看效果
   切换到 版本A → 查看效果
   选择你喜欢的版本继续工作
   ```

7. **删除不需要的分支**
   ```
   分支管理 → 删除分支 → 选择要删除的分支
   注意：主分支和当前分支不能删除
   ```

**分支结构示例**：
```
主分支 (main)
├─ Op1: 创建项目
├─ Op2: 生成小说设定
├─ Op3: 生成大纲
├─ Op4: 生成第1章
│  ├─ Op5a: 修改第1章（悲剧风格） ← main分支
│  └─ Op5b: 修改第1章（喜剧风格） ← version_comedy分支
│      └─ Op6b: 继续修改
│      └─ Op7b: 生成第2章
```

## 高级功能

### 操作合并

系统会自动合并相邻的相似操作，减少历史记录占用：

**示例**：
```
原始操作序列：
1. 修改第1章: "" → "你"
2. 修改第1章: "你" → "你好"
3. 修改第1章: "你好" → "你好世界"

自动合并后：
1. 修改第1章: "" → "你好世界"
```

**合并条件**：
- 相同的操作类型
- 相同的目标对象
- 时间间隔小于2秒

**好处**：
- 撤销一次就能回到编辑前的状态
- 不会产生大量琐碎的历史记录
- 节省内存和存储空间

### 操作组（批量操作）

对于批量操作，可以将多个操作作为一个单位进行撤销：

**编程示例**：
```python
# 开始操作组
self.undo_redo.begin_group("批量生成章节 1-10")

# 执行多个操作
for i in range(1, 11):
    # 生成章节...
    self.undo_redo.record_chapter_generation(str(i), content, len(content))

# 结束操作组
self.undo_redo.end_group()
```

**效果**：
- 撤销一次会撤销所有10个章节的生成
- 重做一次会恢复所有10个章节

### 持久化存储

操作历史会自动保存到磁盘：

**存储位置**：
```
项目目录/.undo_redo_history.pkl
```

**特点**：
- 自动保存：每次操作后自动保存
- 自动加载：打开项目时自动加载历史
- 跨会话：关闭应用后重新打开，历史仍然存在

**管理建议**：
- 定期导出重要的操作历史
- 项目完成后可以删除 `.undo_redo_history.pkl` 文件以节省空间
- 如果历史文件损坏，删除它即可重新开始

## 最佳实践

### 1. 养成保存的习惯

```
编辑 → 保存 → 记录到历史
      ↑
   重要步骤！
```

只有保存后的操作才会被记录到撤销系统。

### 2. 在重大修改前创建分支

```
重大修改前 → 创建分支 → 在分支上实验
          → 成功 → 继续
          → 失败 → 切换回主分支
```

这样可以安全地尝试不同的修改方向。

### 3. 定期导出操作历史

```
Ctrl+H → 导出历史 → 保存到文件
```

作为额外的备份和记录。

### 4. 使用描述性的分支名称

```
好的分支名：
- "version_tragedy"（悲剧版本）
- "version_comedy"（喜剧版本）
- "experiment_new_plot"（新情节实验）

不好的分支名：
- "test1"
- "branch1"
- "temp"
```

### 5. 及时清理不需要的分支

```
分支管理 → 删除分支 → 选择不需要的分支
```

保持分支列表简洁。

### 6. 注意操作历史的大小

系统最多保留1000条操作记录。如果达到上限：
- 最旧的操作会被自动删除
- 可以手动清空历史重新开始

## 故障排除

### 问题：按 Ctrl+Z 没有反应

**可能原因**：
1. 没有可撤销的操作
2. 焦点不在应用程序窗口上

**解决方法**：
1. 按 `Ctrl+H` 查看操作历史，确认是否有操作
2. 点击应用程序窗口确保焦点正确
3. 检查是否在文本编辑框内（编辑框有自己的撤销功能）

### 问题：保存后操作没有被记录

**可能原因**：
1. 内容没有实际改变
2. 撤销/重做系统未正确初始化

**解决方法**：
1. 确保修改了内容后再保存
2. 重启应用程序
3. 查看日志文件了解详细错误

### 问题：撤销后文件没有恢复

**可能原因**：
1. 文件权限问题
2. 磁盘空间不足
3. 文件被其他程序占用

**解决方法**：
1. 检查文件权限
2. 确保有足够的磁盘空间
3. 关闭可能占用文件的其他程序

### 问题：历史记录丢失

**可能原因**：
1. `.undo_redo_history.pkl` 文件被删除
2. 切换了项目目录
3. 文件损坏

**解决方法**：
1. 检查项目目录中是否存在历史文件
2. 如果文件损坏，删除它重新开始
3. 定期导出历史作为备份

### 问题：应用程序变慢

**可能原因**：
1. 操作历史太多
2. 历史文件太大

**解决方法**：
1. 清空操作历史：`Ctrl+H` → 清空历史
2. 删除 `.undo_redo_history.pkl` 文件
3. 减少自动合并的时间间隔（需要修改代码）

## 技术细节

### 支持的操作类型

```python
# 内容编辑
EDIT_CHAPTER         # 修改章节内容
ADD_CHAPTER          # 添加章节
DELETE_CHAPTER       # 删除章节
BATCH_REPLACE        # 批量替换
DELETE_VOLUME        # 删除卷
RESTORE_VOLUME       # 恢复卷

# 配置修改
MODIFY_CONFIG        # 修改配置
MODIFY_LLM_PARAMS    # 修改LLM参数
MODIFY_CHARACTER     # 修改角色
MODIFY_STYLE_PROFILE # 修改风格档案

# 生成操作
GENERATE_CHAPTER      # 生成章节
GENERATE_SETTING      # 生成设定
GENERATE_ARCHITECTURE # 生成架构
GENERATE_BLUEPRINT    # 生成蓝图
STYLE_CHECK_FIX       # 风格检查修复

# 组织操作
MOVE_CHAPTER  # 移动章节
REORDER       # 重新排序
MODIFY_TAG    # 修改标签

# 知识库操作
IMPORT_KNOWLEDGE     # 导入知识
CLEAR_VECTORSTORE    # 清空向量库
```

### 性能特性

- **最大历史记录**: 1000条
- **自动合并时间间隔**: 2秒
- **持久化格式**: pickle
- **内存占用**: 约 1-10MB（取决于操作数量）

### 扩展开发

如果你想添加新的可撤销操作：

```python
# 1. 在 core/undo_redo_manager.py 中添加操作类型
class OperationType(Enum):
    YOUR_NEW_OPERATION = "your_new_operation"

# 2. 在 ui/undo_redo_integration.py 中添加记录方法
def record_your_operation(self, target, old_value, new_value):
    operation = Operation(
        operation_type=OperationType.YOUR_NEW_OPERATION,
        target=target,
        old_value=old_value,
        new_value=new_value
    )
    self.manager.record_operation(operation)

# 3. 在 ui/undo_redo_integration.py 中添加应用方法
def _apply_your_operation(self, operation, is_undo, filepath):
    # 实现撤销/重做逻辑
    pass

# 4. 在相应的UI代码中调用记录方法
if hasattr(self, 'undo_redo'):
    self.undo_redo.record_your_operation(...)
```

## 常见问题 (FAQ)

**Q: 撤销/重做会影响已保存的文件吗？**
A: 是的，撤销操作会实际修改文件内容，确保UI和文件保持一致。

**Q: 可以撤销多少步？**
A: 最多1000步，超过的旧操作会被自动删除。

**Q: 分支之间的操作会互相影响吗？**
A: 不会，每个分支有独立的操作历史。

**Q: 关闭应用后历史会保留吗？**
A: 会的，历史会保存到 `.undo_redo_history.pkl` 文件中。

**Q: 可以在不同电脑间同步历史吗？**
A: 目前不支持，但可以手动复制 `.undo_redo_history.pkl` 文件。

**Q: 撤销系统会占用多少磁盘空间？**
A: 通常在几MB以内，取决于操作数量和内容大小。

**Q: 可以禁用撤销系统吗？**
A: 可以，但不建议。如果需要，可以在代码中移除 `UndoRedoIntegration` 的初始化。

## 更新日志

### v1.0.0 (当前版本)
- ✅ 基本撤销/重做功能
- ✅ 操作历史面板
- ✅ 分支管理
- ✅ 操作合并优化
- ✅ 持久化存储
- ✅ 观察者模式通知
- ✅ 支持章节编辑
- ✅ 支持设定编辑
- ✅ 支持章节生成

### 计划中的功能
- [ ] 可视化时间线
- [ ] 智能合并算法改进
- [ ] 云端同步
- [ ] 协作冲突解决
- [ ] 操作回放动画

## 反馈和支持

如果你发现bug或有改进建议：
1. 提交 GitHub Issue
2. 发送邮件到项目维护者
3. 在项目讨论区发帖

感谢使用 AI Novel Generator 的撤销/重做系统！
